<!DOCTYPE html>
<html>
<head>
    <title>Chat Room</title>
    <style>
        #chat-log { border:1px solid #ccc; height:400px; overflow-y:scroll; padding:10px; margin-bottom:10px; }
        #chat-message-input, #chat-file-input { margin-bottom:5px; }
        #chat-message-input { width:70%; }
        #chat-message-submit { width:28%; }
        .message { margin-bottom:10px; }
        .message img { max-width:200px; display:block; margin-top:5px; }
        .message a { display:block; margin-top:5px; color:blue; }
    </style>
</head>
<body>
<h2>Room ID: {{ conversation_id }}</h2>

<div id="chat-log"></div>

<input id="chat-message-input" type="text" placeholder="Type a message...">
<input id="chat-file-input" type="file">
<button id="chat-message-submit">Send</button>

<script>
const conversationId = "{{ conversation_id }}"; // Pass integer from Django view
const chatLog = document.querySelector("#chat-log");
const messageInput = document.querySelector("#chat-message-input");
const fileInput = document.querySelector("#chat-file-input");
const messageSubmit = document.querySelector("#chat-message-submit");

const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
const chatSocket = new WebSocket(wsProtocol + '://' + window.location.host + '/ws/chat/' + conversationId + '/');

chatSocket.onopen = function() {
    console.log("WebSocket connected for conversation " + conversationId);
};

chatSocket.onmessage = function(e) {
    let data = JSON.parse(e.data);
    if (data.message) data = data.message; // Backend sends message under 'message' key
    appendMessage(data);
};

chatSocket.onclose = function(e) {
    console.error("Chat socket closed unexpectedly.");
};

chatSocket.onerror = function(e) {
    console.error("WebSocket error:", e);
};

function appendMessage(data) {
    const div = document.createElement("div");
    div.classList.add("message");
    div.innerHTML = `<strong>${data.sender}:</strong> ${data.text || ""}`;

    if (data.image_url) {
        const img = document.createElement("img");
        img.src = data.image_url;
        div.appendChild(img);
    }

    if (data.file_url) {
        const link = document.createElement("a");
        link.href = data.file_url;
        link.target = "_blank";
        link.textContent = "Download file";
        div.appendChild(link);
    }

    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function getBase64(file, callback) {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => callback(reader.result);
    reader.onerror = error => console.error(error);
}

messageSubmit.onclick = function() {
    const text = messageInput.value.trim();
    const file = fileInput.files[0];

    if (!text && !file) return;

    if (file) {
        getBase64(file, (fileData) => {
            chatSocket.send(JSON.stringify({
                text: text,
                file: fileData.split(',')[1],
                file_name: file.name
            }));
            messageInput.value = '';
            fileInput.value = '';
        });
    } else {
        chatSocket.send(JSON.stringify({ text: text }));
        messageInput.value = '';
    }
};

messageInput.addEventListener("keyup", function(e) {
    if (e.key === "Enter") messageSubmit.click();
});
</script>
</body>
</html>
